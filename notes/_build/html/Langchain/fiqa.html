

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>QA System on fiqa dataset &#8212; Notes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Langchain/fiqa';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    <p class="title logo__title">Notes</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../mf-guidence/README.html">Guidence</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../mf-guidence/guidence101.html">Guidence 101</a></li>
</ul>
</li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="README.html">Langchain Internals</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="prompts.html">Prompts</a></li>
<li class="toctree-l2"><a class="reference internal" href="chains.html">Chains - Intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="evaluations.html">Evaluations - Intro</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2FLangchain/fiqa.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Langchain/fiqa.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>QA System on fiqa dataset</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seed-questions">Seed questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-with-groundtruth">Evaluate with GroundTruth</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-with-ragas">Evaluate with Ragas</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-context-free">Evaluate context-free</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-a-rag-pipeline">Evaluate a RAG pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#langchain-stringevaluator">Langchain stringEvaluator</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="qa-system-on-fiqa-dataset">
<h1>QA System on fiqa dataset<a class="headerlink" href="#qa-system-on-fiqa-dataset" title="Permalink to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">fiqa_corpus</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;explodinggradients/fiqa&quot;</span><span class="p">,</span> <span class="s2">&quot;corpus&quot;</span><span class="p">)[</span><span class="s1">&#39;corpus&#39;</span><span class="p">]</span>
<span class="n">fiqa_qa</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;explodinggradients/fiqa&quot;</span><span class="p">,</span> <span class="s2">&quot;main&quot;</span><span class="p">)[</span><span class="s2">&quot;test&quot;</span><span class="p">]</span>
<span class="n">fiqa_corpus</span><span class="p">,</span> <span class="n">fiqa_qa</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found cached dataset fiqa (/home/jjmachan/.cache/huggingface/datasets/explodinggradients___fiqa/corpus/1.0.0/3dc7b639f5b4b16509a3299a2ceb78bf5fe98ee6b5fee25e7d5e4d290c88efb8)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "9bb60bcdd94f45e6a56858ad2b1dc705", "version_major": 2, "version_minor": 0}</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Found cached dataset fiqa (/home/jjmachan/.cache/huggingface/datasets/explodinggradients___fiqa/main/1.0.0/3dc7b639f5b4b16509a3299a2ceb78bf5fe98ee6b5fee25e7d5e4d290c88efb8)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "634113b0ec1844eda349f17c2c1dbdef", "version_major": 2, "version_minor": 0}</script><div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(Dataset({
     features: [&#39;doc&#39;],
     num_rows: 57638
 }),
 Dataset({
     features: [&#39;question&#39;, &#39;ground_truths&#39;],
     num_rows: 648
 }))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.embeddings</span> <span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">Chroma</span>
<span class="kn">from</span> <span class="nn">langchain.schema</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="p">[</span><span class="s2">&quot;ground_truths&quot;</span><span class="p">]</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Document</span><span class="p">(</span><span class="n">page_content</span><span class="o">=</span><span class="n">t</span><span class="p">))</span>
        
<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span>
    <span class="n">documents</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span>
    <span class="n">embedding</span><span class="o">=</span><span class="n">OpenAIEmbeddings</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1706
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span>
<span class="n">q</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Using credit card points to pay for tax deductible business expenses&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">response_docs</span> <span class="o">=</span> <span class="n">vectorstore</span><span class="o">.</span><span class="n">similarity_search</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
<span class="n">response_docs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[Document(page_content=&#39;&quot;For simplicity, let\&#39;s start by just considering cash back. In general, cash back from credit cards for personal use is not taxable, but for business use it is taxable (sort of, I\&#39;ll explain later). The reason is most personal purchases are made with after tax dollars; you typically aren\&#39;t deducting the cost of what you purchased from your personal income, so if you purchase something that costs $100 and you receive $2 back from the CC company, effectively you have paid $98 for that item but that wouldn\&#39;t affect your tax bill. However, since businesses typically deduct most expenses, that same $100 deduction would have only been a $98 deduction for business tax purposes, so in this case the $2 should be accounted for. Note, you should not consider that $2 as income though; that would artificially inflate your revenue. It should be treated as a negative expense, similar to how you would handle returning an item you purchased and receiving a CC refund. Now for your specific questions: Part 1: As a small business owner, I wish to attend an annual seminar to improve my business. I have enough credit card reward points to cover the airfare, hotel, and rental car. Will those expenses still be deductible at the value displayed on the receipt? Effectively no, these expenses are not deductible. If you deduct them they will be completely counter-acted by the &quot;&quot;refund&quot;&quot; you receive for the payments. Part 2: Does it matter if those points are accrued on my personal credit card, rather than a business credit card? This is where it gets hairy. Suppose your company policy is that employees make purchases with their own personal credit cards and submit receipts for reimbursement. In this case the employer can simply reimburse and would not know or care if the employee is racking up rewards/points/cashback. The trick is, as the employee, you must always purchase business related items normally so you have receipts to show, and if you receive cashback on the side there seems to be a &quot;&quot;don\&#39;t ask, don\&#39;t tell&quot;&quot; rule that the IRS is OK with. It works the same way with heavy business travelers and airline miles- the free vacations those users get as perks are not treated as taxable income. However, I would not go out of my way to abuse this &quot;&quot;loophole&quot;&quot;. Typically, things like travel (airfare, hotel, car rental, meals) are expected. But I wouldn\&#39;t go purchase 100 company laptops on your personal card and ask the company to reimburse you. The company should purchase those 100 laptops on a company card and effectively reduce the sale price by the cashback received. (Or more realistically, negotiate a better discount with your account rep and just cut them a check.) Part 3: Would there be any difference between credit card points and brand-loyalty points? If the rental car were paid for with points earned directly on the rental car company\&#39;s loyalty system (not a CC), would that yield a different result? There is no difference. Perhaps the simplest way to think about this is you can only deduct an expense that you actually incur. In other words, the expense should show up on a bank or CC statement. This is why when you volunteer and work 10 hours for a charity, you can\&#39;t call that a &quot;&quot;donation&quot;&quot; of any amount of money because there is no actual payment made that would show up on a bank statement. Instead you could have billed the charity for your 10 hours of work, and then turned around and donated that same amount back to them, but it ends up being a wash.&quot;&#39;, metadata={}),
 Document(page_content=&#39;&quot;There are two fundamentally different reasons merchants will give cash discounts. One is that they will not have to pay interchange fees on cash (or pay much lower fees on no-reward debit cards).  Gas stations in my home state of NJ already universally offer different cash and credit prices.  Costco will not even take Visa and MasterCard credit cards (debit only) for this reason. The second reason, not often talked about but widely known amongst smaller merchants, is that they can fail to declare the sale (or claim a smaller portion of the sale) to the authorities in order to reduce their tax liability.  Obviously the larger stores will not risk their jobs for this, but smaller owner-operated (&quot;&quot;mom and pop&quot;&quot;) stores often will.  This applies to both reduced sales tax liability and income tax liability.  This used to be more limited per sale (but more widespread overall), since tax authorities would look closely for a mismatch between declared income and spending, but with an ever-larger proportion of customers paying by credit card, merchants can take a bigger chunk of their cash sales off the books without drawing too much suspicion. Both of the above are more applicable to TVs than cars, since (1) car salesmen make substantial money from offering financing and (2) all cars must be registered with the state, so alternative records of sales abound.  Also, car prices tend to be at or near the credit limit of most cards, so it is not as common to pay for them in this way.&quot;&#39;, metadata={}),
 Document(page_content=&quot;I had $70K in credit card at one point.  Limited income, starting a business - it&#39;s the only credit available. (yes, all paid off now).&quot;, metadata={}),
 Document(page_content=&#39;&quot;I pay taxes on revenue.  You do have the ability to deduct expenses, though it\&#39;s not as comprehensive as what companies can do: These figures apply to everybody, so those that earn more get taxed more on thee additional income in each bracket (meaning the first $100,000 of taxable income is taxed the same for everybody at one rate, the next $100,000 at a different rate, etc.) So you do get to deduct personal expenses and get taxed on &quot;&quot;profit&quot;&quot; - but since the vast majority of people don\&#39;t keep detailed records of what they spend, it\&#39;s much simpler just to use blanket deduction amounts for everyone. Companies have much more detailed systems in place to track and categorize expenses, so it\&#39;s easier to just tax on net profit. Plus, the corporate tax rate is much higher than the average individual tax rate - would you trade more deductions for a higher tax rate?&quot;&#39;, metadata={})]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.chains</span> <span class="kn">import</span> <span class="n">RetrievalQA</span>
<span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qa_chain</span> <span class="o">=</span> <span class="n">RetrievalQA</span><span class="o">.</span><span class="n">from_chain_type</span><span class="p">(</span>
    <span class="n">llm</span><span class="p">,</span>
    <span class="n">retriever</span><span class="o">=</span><span class="n">vectorstore</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(),</span>
    <span class="n">return_source_documents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">qa_chain</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;query&#39;: &#39;Using credit card points to pay for tax deductible business expenses&#39;,
 &#39;result&#39;: &#39;Using credit card points to pay for tax deductible business expenses can be a bit tricky. Generally, if you use credit card points to cover business expenses, those expenses may not be deductible. This is because the points effectively reduce the cost of the expenses, and deducting them would be counteracted by the value of the points. However, if you have a company policy where employees make purchases with their personal credit cards and submit receipts for reimbursement, the employer may not be concerned with the rewards or points earned. In this case, as long as the expenses are legitimate business expenses, they should still be deductible. It\&#39;s important to note that this &quot;don\&#39;t ask, don\&#39;t tell&quot; approach may not be advisable to abuse, and it\&#39;s always best to consult with a tax professional for specific guidance.&#39;,
 &#39;source_documents&#39;: [Document(page_content=&#39;&quot;For simplicity, let\&#39;s start by just considering cash back. In general, cash back from credit cards for personal use is not taxable, but for business use it is taxable (sort of, I\&#39;ll explain later). The reason is most personal purchases are made with after tax dollars; you typically aren\&#39;t deducting the cost of what you purchased from your personal income, so if you purchase something that costs $100 and you receive $2 back from the CC company, effectively you have paid $98 for that item but that wouldn\&#39;t affect your tax bill. However, since businesses typically deduct most expenses, that same $100 deduction would have only been a $98 deduction for business tax purposes, so in this case the $2 should be accounted for. Note, you should not consider that $2 as income though; that would artificially inflate your revenue. It should be treated as a negative expense, similar to how you would handle returning an item you purchased and receiving a CC refund. Now for your specific questions: Part 1: As a small business owner, I wish to attend an annual seminar to improve my business. I have enough credit card reward points to cover the airfare, hotel, and rental car. Will those expenses still be deductible at the value displayed on the receipt? Effectively no, these expenses are not deductible. If you deduct them they will be completely counter-acted by the &quot;&quot;refund&quot;&quot; you receive for the payments. Part 2: Does it matter if those points are accrued on my personal credit card, rather than a business credit card? This is where it gets hairy. Suppose your company policy is that employees make purchases with their own personal credit cards and submit receipts for reimbursement. In this case the employer can simply reimburse and would not know or care if the employee is racking up rewards/points/cashback. The trick is, as the employee, you must always purchase business related items normally so you have receipts to show, and if you receive cashback on the side there seems to be a &quot;&quot;don\&#39;t ask, don\&#39;t tell&quot;&quot; rule that the IRS is OK with. It works the same way with heavy business travelers and airline miles- the free vacations those users get as perks are not treated as taxable income. However, I would not go out of my way to abuse this &quot;&quot;loophole&quot;&quot;. Typically, things like travel (airfare, hotel, car rental, meals) are expected. But I wouldn\&#39;t go purchase 100 company laptops on your personal card and ask the company to reimburse you. The company should purchase those 100 laptops on a company card and effectively reduce the sale price by the cashback received. (Or more realistically, negotiate a better discount with your account rep and just cut them a check.) Part 3: Would there be any difference between credit card points and brand-loyalty points? If the rental car were paid for with points earned directly on the rental car company\&#39;s loyalty system (not a CC), would that yield a different result? There is no difference. Perhaps the simplest way to think about this is you can only deduct an expense that you actually incur. In other words, the expense should show up on a bank or CC statement. This is why when you volunteer and work 10 hours for a charity, you can\&#39;t call that a &quot;&quot;donation&quot;&quot; of any amount of money because there is no actual payment made that would show up on a bank statement. Instead you could have billed the charity for your 10 hours of work, and then turned around and donated that same amount back to them, but it ends up being a wash.&quot;&#39;, metadata={}),
  Document(page_content=&#39;&quot;There are two fundamentally different reasons merchants will give cash discounts. One is that they will not have to pay interchange fees on cash (or pay much lower fees on no-reward debit cards).  Gas stations in my home state of NJ already universally offer different cash and credit prices.  Costco will not even take Visa and MasterCard credit cards (debit only) for this reason. The second reason, not often talked about but widely known amongst smaller merchants, is that they can fail to declare the sale (or claim a smaller portion of the sale) to the authorities in order to reduce their tax liability.  Obviously the larger stores will not risk their jobs for this, but smaller owner-operated (&quot;&quot;mom and pop&quot;&quot;) stores often will.  This applies to both reduced sales tax liability and income tax liability.  This used to be more limited per sale (but more widespread overall), since tax authorities would look closely for a mismatch between declared income and spending, but with an ever-larger proportion of customers paying by credit card, merchants can take a bigger chunk of their cash sales off the books without drawing too much suspicion. Both of the above are more applicable to TVs than cars, since (1) car salesmen make substantial money from offering financing and (2) all cars must be registered with the state, so alternative records of sales abound.  Also, car prices tend to be at or near the credit limit of most cards, so it is not as common to pay for them in this way.&quot;&#39;, metadata={}),
  Document(page_content=&quot;I had $70K in credit card at one point.  Limited income, starting a business - it&#39;s the only credit available. (yes, all paid off now).&quot;, metadata={}),
  Document(page_content=&#39;&quot;I pay taxes on revenue.  You do have the ability to deduct expenses, though it\&#39;s not as comprehensive as what companies can do: These figures apply to everybody, so those that earn more get taxed more on thee additional income in each bracket (meaning the first $100,000 of taxable income is taxed the same for everybody at one rate, the next $100,000 at a different rate, etc.) So you do get to deduct personal expenses and get taxed on &quot;&quot;profit&quot;&quot; - but since the vast majority of people don\&#39;t keep detailed records of what they spend, it\&#39;s much simpler just to use blanket deduction amounts for everyone. Companies have much more detailed systems in place to track and categorize expenses, so it\&#39;s easier to just tax on net profit. Plus, the corporate tax rate is much higher than the average individual tax rate - would you trade more deductions for a higher tax rate?&quot;&#39;, metadata={})]}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo-16k&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">llm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using credit card points to pay for tax deductible business expenses can be a smart financial move for business owners. Here are a few steps to follow:

1. Understand your credit card rewards program: Familiarize yourself with the specific terms and conditions of your credit card rewards program. Determine the value of the points and how they can be redeemed for statement credits, gift cards, or other options.

2. Identify tax-deductible business expenses: Make a list of all the qualifying tax-deductible business expenses you plan to pay for. This may include office supplies, travel expenses, marketing costs, or professional services.

3. Calculate the value of your points: Determine the value of your credit card points based on the redemption options available. For example, if each point is worth $0.01 and you have 10,000 points, you have $100 in credit to use.

4. Choose the best redemption option: Evaluate the redemption options available to you and choose the one that maximizes the value of your points. Opting for a statement credit can be the most straightforward option as it can directly reduce your credit card bill.

5. Pay for tax-deductible expenses with points: Use your credit card points to pay for the tax-deductible business expenses you identified earlier. Ensure that you keep proper documentation and receipts to support the expense claims during tax filing.

6. Track the transaction: Maintain a record of the transactions where you used your credit card points to pay for business expenses. This will help you during tax preparation and ensure accurate reporting.

7. Consult with a tax professional: It&#39;s always a good idea to consult with a tax professional or financial advisor to ensure compliance with tax laws and regulations specific to your jurisdiction.

Remember, using credit card points to pay for tax-deductible business expenses can provide financial benefits, but it&#39;s important to carefully track and document these transactions to avoid any complications during tax filing.
</pre></div>
</div>
</div>
</div>
<section id="seed-questions">
<h2>Seed questions<a class="headerlink" href="#seed-questions" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">SEED</span> <span class="o">=</span> <span class="mi">512</span>

<span class="n">fiqa_qa</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">SEED</span><span class="p">)</span>
<span class="n">fiqa_qa</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">60</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Loading cached shuffled indices for dataset at /home/jjmachan/.cache/huggingface/datasets/explodinggradients___fiqa/main/1.0.0/3dc7b639f5b4b16509a3299a2ceb78bf5fe98ee6b5fee25e7d5e4d290c88efb8/cache-2f0a816219d98636.arrow
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-with-groundtruth">
<h2>Evaluate with GroundTruth<a class="headerlink" href="#evaluate-with-groundtruth" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>
<span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>

<span class="n">qa_with_gt</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Answer the question using only the context provided</span>

<span class="sd">context: {context}</span>
<span class="sd">question: {question}</span>
<span class="sd">answer:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo-16k&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ragas.metrics.base</span> <span class="kn">import</span> <span class="n">make_batches</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">make_batches</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fiqa_qa</span><span class="p">),</span> <span class="mi">20</span><span class="p">)):</span>
    <span class="n">r_batch</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_batch</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">qa_with_gt</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
            <span class="n">context</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;ground_truths&quot;</span><span class="p">]),</span>
            <span class="n">question</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
    <span class="n">res_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">generations</span><span class="p">]</span>
    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res_texts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████| 3/3 [03:20&lt;00:00, 66.67s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>60
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_ds</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;answer_with_gt&quot;</span><span class="p">,</span> <span class="n">generations</span><span class="p">)</span>
<span class="n">final_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;question&#39;, &#39;ground_truths&#39;, &#39;answer_with_gt&#39;],
    num_rows: 60
})
</pre></div>
</div>
</div>
</div>
<section id="evaluate-with-ragas">
<h3>Evaluate with Ragas<a class="headerlink" href="#evaluate-with-ragas" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ragas</span> <span class="kn">import</span> <span class="n">evaluate</span>

<span class="n">ragas_grounded_result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">final_ds</span><span class="p">,</span> <span class="n">column_map</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span>
    <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="s2">&quot;ground_truths&quot;</span><span class="p">,</span>
    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;answer_with_gt&quot;</span>
<span class="p">})</span>

<span class="n">ragas_grounded_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [answer_relevancy]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████| 4/4 [02:44&lt;00:00, 41.07s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [context_relavency]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 4/4 [08:07&lt;00:00, 121.91s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [faithfulness]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 4/4 [09:19&lt;00:00, 139.96s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.5712, &#39;answer_relevancy&#39;: 0.9003, &#39;context_relavency&#39;: 0.3491, &#39;faithfulness&#39;: 0.7833}
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="evaluate-context-free">
<h2>Evaluate context-free<a class="headerlink" href="#evaluate-context-free" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain</span> <span class="kn">import</span> <span class="n">PromptTemplate</span>

<span class="n">qa_with_nocontext</span> <span class="o">=</span> <span class="n">PromptTemplate</span><span class="o">.</span><span class="n">from_template</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;\</span>
<span class="sd">Answer the question</span>

<span class="sd">question: {question}</span>
<span class="sd">answer:</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="n">generations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">make_batches</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fiqa_qa</span><span class="p">),</span> <span class="mi">20</span><span class="p">)):</span>
    <span class="n">r_batch</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">prompts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">r_batch</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">qa_with_nocontext</span><span class="o">.</span><span class="n">format_prompt</span><span class="p">(</span>
            <span class="n">question</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">prompts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">llm</span><span class="o">.</span><span class="n">generate_prompt</span><span class="p">(</span><span class="n">prompts</span><span class="p">)</span>
    <span class="n">res_texts</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">generations</span><span class="p">]</span>
    <span class="n">generations</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">res_texts</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 3/3 [06:19&lt;00:00, 126.51s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">generations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>60
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_ds</span> <span class="o">=</span> <span class="n">final_ds</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;answer_with_no_context&quot;</span><span class="p">,</span> <span class="n">generations</span><span class="p">)</span>
<span class="n">final_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;question&#39;, &#39;ground_truths&#39;, &#39;answer_with_gt&#39;, &#39;answer_with_no_context&#39;],
    num_rows: 60
})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ragas_result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">final_ds</span><span class="p">,</span> <span class="n">column_map</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span>
    <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="s2">&quot;ground_truths&quot;</span><span class="p">,</span>
    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;answer_with_no_context&quot;</span>
<span class="p">})</span>

<span class="n">ragas_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [answer_relevancy]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████| 4/4 [02:23&lt;00:00, 35.83s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [context_relavency]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 25%|███████████████                                             | 1/4 [01:51&lt;05:34, 111.48s/it]Retrying langchain.chat_models.openai.ChatOpenAI.completion_with_retry.&lt;locals&gt;._completion_with_retry in 4.0 seconds as it raised APIConnectionError: Error communicating with OpenAI: (&#39;Connection aborted.&#39;, RemoteDisconnected(&#39;Remote end closed connection without response&#39;)).
100%|████████████████████████████████████████████████████████████| 4/4 [11:34&lt;00:00, 173.74s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [faithfulness]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 4/4 [16:34&lt;00:00, 248.65s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.4915, &#39;answer_relevancy&#39;: 0.9374, &#39;context_relavency&#39;: 0.3158, &#39;faithfulness&#39;: 0.5347}
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluate-a-rag-pipeline">
<h2>Evaluate a RAG pipeline<a class="headerlink" href="#evaluate-a-rag-pipeline" title="Permalink to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.embeddings</span> <span class="kn">import</span> <span class="n">OpenAIEmbeddings</span>
<span class="kn">from</span> <span class="nn">langchain.vectorstores</span> <span class="kn">import</span> <span class="n">Chroma</span>
<span class="kn">from</span> <span class="nn">langchain.schema</span> <span class="kn">import</span> <span class="n">Document</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="p">[</span><span class="s2">&quot;ground_truths&quot;</span><span class="p">]</span>
<span class="n">docs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
        <span class="n">docs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Document</span><span class="p">(</span><span class="n">page_content</span><span class="o">=</span><span class="n">t</span><span class="p">))</span>
        
<span class="n">vectorstore</span> <span class="o">=</span> <span class="n">Chroma</span><span class="o">.</span><span class="n">from_documents</span><span class="p">(</span>
    <span class="n">documents</span><span class="o">=</span><span class="n">docs</span><span class="p">,</span>
    <span class="n">embedding</span><span class="o">=</span><span class="n">OpenAIEmbeddings</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.chains</span> <span class="kn">import</span> <span class="n">RetrievalQA</span>
<span class="kn">from</span> <span class="nn">langchain.chat_models</span> <span class="kn">import</span> <span class="n">ChatOpenAI</span>

<span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-3.5-turbo&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">qa_chain</span> <span class="o">=</span> <span class="n">RetrievalQA</span><span class="o">.</span><span class="n">from_chain_type</span><span class="p">(</span>
    <span class="n">llm</span><span class="p">,</span>
    <span class="n">retriever</span><span class="o">=</span><span class="n">vectorstore</span><span class="o">.</span><span class="n">as_retriever</span><span class="p">(),</span>
    <span class="n">return_source_documents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>


<span class="c1"># try it out</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">fiqa_qa</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">qa_chain</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">})</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&quot;To deposit a cheque issued to an associate in your business into your business account, you have a few options:\n\n1. Third-Party Endorsement: Have the associate sign the back of the cheque and then deposit it into your business account. This is called a third-party cheque and is generally allowed. However, there may be a longer hold period for the funds, and if the cheque doesn&#39;t clear, you won&#39;t receive the money.\n\n2. In-Person Endorsement: If the cheque is for a large amount or you&#39;re not well-known at the bank, you can have the associate go to the bank with the cheque and endorse it in front of a teller, providing some form of identification. This can help establish the legitimacy of the transaction.\n\n3. Deposit into Associate&#39;s Account: Alternatively, the associate can deposit the cheque into their own account and then write a cheque to your business for the same amount. This may be a simpler option if you encounter difficulties with the first two methods.\n\nIt&#39;s important to note that the specific requirements and policies may vary depending on the bank and the nature of your business. It&#39;s recommended to contact your bank directly to confirm their procedures for depositing third-party cheques into a business account.&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">answer_from_rag</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">contexts</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">fiqa_qa</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">qa_chain</span><span class="p">({</span><span class="s2">&quot;query&quot;</span><span class="p">:</span> <span class="n">q</span><span class="p">})</span>
    <span class="n">answer_from_rag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;result&quot;</span><span class="p">])</span>
    <span class="n">contexts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">page_content</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;source_documents&quot;</span><span class="p">]]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> 37%|█████████████████████▋                                     | 22/60 [02:04&lt;02:31,  3.98s/it]Failed to patch https://api.smith.langchain.com/runs/59b41992-e741-4f86-ad48-b5ff0773a88b in LangSmith API. {&quot;detail&quot;:&quot;Cannot update a run that has already finished&quot;}
100%|███████████████████████████████████████████████████████████| 60/60 [05:28&lt;00:00,  5.47s/it]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_ds</span> <span class="o">=</span> <span class="n">final_ds</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;answer_with_rag&quot;</span><span class="p">,</span> <span class="n">answer_from_rag</span><span class="p">)</span>
<span class="n">final_ds</span> <span class="o">=</span> <span class="n">final_ds</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s2">&quot;contexts_from_rag&quot;</span><span class="p">,</span> <span class="n">contexts</span><span class="p">)</span>
<span class="n">final_ds</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dataset({
    features: [&#39;question&#39;, &#39;ground_truths&#39;, &#39;answer_with_gt&#39;, &#39;answer_with_no_context&#39;, &#39;answer_with_rag&#39;, &#39;contexts_from_rag&#39;],
    num_rows: 60
})
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ragas_rag_result</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">final_ds</span><span class="p">,</span> <span class="n">column_map</span><span class="o">=</span><span class="p">{</span>
    <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span>
    <span class="s2">&quot;contexts&quot;</span><span class="p">:</span> <span class="s2">&quot;contexts_from_rag&quot;</span><span class="p">,</span>
    <span class="s2">&quot;answer&quot;</span><span class="p">:</span> <span class="s2">&quot;answer_with_rag&quot;</span>
<span class="p">})</span>

<span class="n">ragas_rag_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [answer_relevancy]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|█████████████████████████████████████████████████████████████| 4/4 [02:24&lt;00:00, 36.23s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [context_relavency]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 4/4 [07:10&lt;00:00, 107.54s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>evaluating with [faithfulness]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|████████████████████████████████████████████████████████████| 4/4 [14:47&lt;00:00, 221.97s/it]
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.3355, &#39;answer_relevancy&#39;: 0.9110, &#39;context_relavency&#39;: 0.1512, &#39;faithfulness&#39;: 0.8122}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ragas_free_result</span> <span class="o">=</span> <span class="n">ragas_result</span>
<span class="n">ragas_free_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.4915, &#39;answer_relevancy&#39;: 0.9374, &#39;context_relavency&#39;: 0.3158, &#39;faithfulness&#39;: 0.5347}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ragas_rag_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.3355, &#39;answer_relevancy&#39;: 0.9110, &#39;context_relavency&#39;: 0.1512, &#39;faithfulness&#39;: 0.8122}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ragas_grounded_result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;ragas_score&#39;: 0.5712, &#39;answer_relevancy&#39;: 0.9003, &#39;context_relavency&#39;: 0.3491, &#39;faithfulness&#39;: 0.7833}
</pre></div>
</div>
</div>
</div>
<section id="langchain-stringevaluator">
<h3>Langchain stringEvaluator<a class="headerlink" href="#langchain-stringevaluator" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">langchain.evaluation</span> <span class="kn">import</span> <span class="n">StringEvaluator</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">ragas.metrics.base</span> <span class="kn">import</span> <span class="n">Metric</span>
<span class="kn">from</span> <span class="nn">langchain.chains</span> <span class="kn">import</span> <span class="n">LLMChain</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LangchainEvaluator</span><span class="p">(</span><span class="n">StringEvaluator</span><span class="p">,</span> <span class="n">Chain</span><span class="p">):</span>
    <span class="n">metrics</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Metric</span><span class="p">]</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_metric</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span> <span class="n">Metric</span><span class="p">):</span>
        <span class="o">...</span>
        
    <span class="k">def</span> <span class="nf">_evaluate_strings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">prediction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">reference</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">input</span><span class="p">:</span> <span class="nb">str</span> 
    <span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Langchain"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#seed-questions">Seed questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-with-groundtruth">Evaluate with GroundTruth</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-with-ragas">Evaluate with Ragas</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-context-free">Evaluate context-free</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#evaluate-a-rag-pipeline">Evaluate a RAG pipeline</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#langchain-stringevaluator">Langchain stringEvaluator</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By ExplodingGradients
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>